<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <link href="../App_Themes/Map/css/reset.css" rel="stylesheet" type="text/css">
    <link href="../App_Themes/Map/css/bootstrap.css" rel="stylesheet" type="text/css">
    <link href="../App_Themes/Map/css/layout.css" rel="stylesheet" type="text/css">
    <link href="../App_Themes/Map/css/map.css" rel="stylesheet" type="text/css">
    <link href="../App_Themes/Map/css/nanoscroller.css" rel="stylesheet" type="text/css">
    <link href="../App_Themes/Map/css/table.css" rel="stylesheet" type="text/css">


    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="true">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Mulish:wght@200;300;400;500;600;700;800;900&amp;display=swa">
</head>

<body>
    <div class="BtnFunc">
        <ul>
            <li class="close"><a href="javascript:void(0);parent.toolSwitch()">關閉</a></li>
        </ul>
    </div>
    <!--關閉+說明-->
    <!--頁籤-->
    <div class="TabBox">
        <input type="button" name="button" class="BtnTab TabActive" value="主題圖" onclick="switchLayerTab('主題圖')">
        <input type="button" name="button" class="BtnTab" value="測站" onclick="switchLayerTab('測站')">
    </div>
    <!--頁籤結尾-->
    <!--可捲動範圍-->
    <div class="nano" style="height: 681px;">
        <div class="nano-content">
            <!-- 圖層清單 -->
            <div id="legend">
                <div id="content">
                    <input type="button" name="button" class="BtnClear" value="清除套疊" style="float: right"
                        onclick="hideAllLayer();">
                    <table id="legendTable" width="100%" border="0" cellpadding="0" cellspacing="0">
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/計畫範圍')"><img
                                    src="https://102kmsystem.wratb.gov.tw/geoserver/RoadNineSlide/ows?service=WMS&amp;request=GetLegendGraphic&amp;format=image%2Fpng&amp;width=24&amp;height=24&amp;layer=map_scope_plan"
                                    style="width:22px; height:22px;">計畫範圍</td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/監測範圍')"><img
                                    src="https://102kmsystem.wratb.gov.tw/geoserver/RoadNineSlide/ows?service=WMS&amp;request=GetLegendGraphic&amp;format=image%2Fpng&amp;width=24&amp;height=24&amp;layer=map_scope_monitor"
                                    style="width:22px; height:22px;">監測範圍</td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/轄區範圍')"><img
                                    src="https://102kmsystem.wratb.gov.tw/geoserver/RoadNineSlide/ows?service=WMS&amp;request=GetLegendGraphic&amp;format=image%2Fpng&amp;width=24&amp;height=24&amp;layer=map_scope_wratb"
                                    style="width:22px; height:22px;">轄區範圍</td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/county')"><img
                                    src="https://102kmsystem.wratb.gov.tw/geoserver/RoadNineSlide/ows?service=WMS&amp;request=GetLegendGraphic&amp;format=image%2Fpng&amp;width=24&amp;height=24&amp;layer=map_county_wratb"
                                    style="width:22px; height:22px;">縣市界</td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/town')"><img
                                    src="https://102kmsystem.wratb.gov.tw/geoserver/RoadNineSlide/ows?service=WMS&amp;request=GetLegendGraphic&amp;format=image%2Fpng&amp;width=24&amp;height=24&amp;layer=map_town_wratb"
                                    style="width:22px; height:22px;">鄉鎮區界</td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/土石流潛勢溪流')"><img
                                    src="https://102kmsystem.wratb.gov.tw/geoserver/RoadNineSlide/ows?service=WMS&amp;request=GetLegendGraphic&amp;format=image%2Fpng&amp;width=24&amp;height=24&amp;layer=map_protential_debris_wratb"
                                    style="width:22px; height:22px;">土石流潛勢溪流</td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/山崩與地滑地質敏感區')"><img
                                    src="https://102kmsystem.wratb.gov.tw/geoserver/RoadNineSlide/ows?service=WMS&amp;request=GetLegendGraphic&amp;format=image%2Fpng&amp;width=24&amp;height=24&amp;layer=map_easy_landslide_wratb"
                                    style="width:22px; height:22px;">山崩與地滑地質敏感區</td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/QPESUMS過去一小時')"><img
                                    src="../images/map_legend/雷達迴波圖.png" style="width:22px; height:22px;">QPESUMS過去一小時
                            </td>
                        </tr>
                        <tr>
                            <td style="display:block;vertical-align:text-bottom" class="TreeNode"><input type="checkbox"
                                    onchange="swicthLayerVisible(this, '主題圖/QPESUMS未來一小時')"><img
                                    src="../images/map_legend/雷達迴波圖.png" style="width:22px; height:22px;">QPESUMS未來一小時
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--可捲動範圍結尾-->


</body>

<script src="../script/map/jquery.js" type="text/javascript"></script>
<script src="../script/map/bootstrap.js" type="text/javascript"></script>

<!-- <script type="text/javascript">
    var digit = 2;
    var parentMapLayerObj = "parent.map_layers";
    var resizeInterval = null;
    var mapPlugin = null;
    $(function () {
        mapPlugin = parent.mapPlugin;
        switchLayerTab("主題圖");
        var chkLayer = $("td:contains('計畫範圍') input:checkbox")[0];
        chkLayer.checked = true;
        swicthLayerVisible(chkLayer, '主題圖/計畫範圍');
    });
    $(window).on("resize", function () {
        clearInterval(resizeInterval);
        resizeInterval = setInterval(resizeLayout, 200);
    });
    function resizeLayout() {
        parent.resizeBox(99999999);
        if ($(".nano").height() != ($("html").height() - $(".nano").offset().top)) {
            $(".nano").height($("html").height() - $(".nano").offset().top);
        }
        clearInterval(resizeInterval);
    }

    function switchLayerTab(layerName) {
        closeLayerAddingPanel();
        createLegend(layerName);
        $("input.BtnTab").removeClass("TabActive");
        $("input.BtnTab[value='" + layerName + "']").addClass("TabActive");
    }

    function switchTreeFolder(obj) {
        var panel = $(obj).parent();
        if ($(obj).parent().hasClass("active")) {
            panel.children(".SubFolderList").fadeOut("slow");
            var ori = panel.children(".SubFolderList").css("height");
            panel.removeClass("active");
        } else {
            panel.find(".SubFolderList").fadeIn("slow");
            panel.addClass("active");
        }
    }

    function swicthLayerVisible(obj, layerID) {
        var disabled = !obj.checked;
        mapPlugin.layersMg.switchTheLayer(layerID, obj.checked);
        var $checkbox = $(obj).parent().find(":checkbox");
        if (disabled) $checkbox.prop("disabled", true);
        $checkbox.prop("checked", $(obj).prop("checked"));
        if (disabled) $checkbox.prop("disabled", false);
    }
</script> -->
<!-- create legend -->
<!-- <script type="text/javascript">
    function createLegend(target) {
        $("#legendTable").children().remove();
        if (parent.map_layers[target] && parent.map_layers[target].sub)
            createFolder($("#legendTable"), parent.map_layers[target].sub, "[\"" + target + "\"].sub");
    }
    // create layer folder
    function createFolder($parentFolderTable, data) {
        for (var layerID in data) {
            var $td = $parentFolderTable.append("<tr><td style='display:block;vertical-align:text-bottom'/></tr>").find("td:last");
            var layerInfo = data[layerID];
            $td.append("<input type='checkbox' onchange=\"swicthLayerVisible(this, '" + layerInfo.layerID + "')\" />");
            if (layerInfo.type == "folder") {
                if (layerInfo.visible) $td.find(':checkbox').prop('checked', true);
                $td.addClass("TreeFolder");
                $td.prepend("<div style='width:20px; height:20px;display:inline-block;cursor:pointer;' onclick='switchTreeFolder(this);'></div>&nbsp;")
                $td.append("<a href='javascript:void(0);' onclick='switchTreeFolder(this);'>" + layerInfo.name + "</a>");
                $td.append("<div style=' display:none;' class='SubFolderList'><table path='" + layerInfo.layerID + "' style='width:100%;'/></div>");
                if (layerInfo.sub)
                    createFolder($td.children().last(), layerInfo.sub);
            } else {
                var layer = mapPlugin.layersMg.getLayer(layerInfo);
                if (layer && layer.getVisible()) $td.find(':checkbox').prop('checked', true);
                // create a layer
                $td.addClass("TreeNode");
                if (layerInfo.legendIcon) {
                    $td.append("<img src='" + ((layerInfo.legendIcon.indexOf("https://") == 0 || layerInfo.legendIcon.indexOf("http://") == 0) ? "" : "../") + layerInfo.legendIcon + "' style='width:22px; height:22px;'/>");
                    $td.append(layerInfo.name);
                } else if (layerInfo.legend) {
                    var align = "left";
                    if (layerInfo.legend.align) align = layerInfo.legend.align;
                    if (align == "bottom") {
                        $td.append(layerInfo.name);
                        $td.append("<br/>");
                        $td.append("<img src='" + ((layerInfo.legendIcon.indexOf("https://") == 0 || layerInfo.legendIcon.indexOf("http://") == 0) ? "" : "../") + layerInfo.legend.url + "' style='padding-left:10px; width:22px; height:22px;'/>");
                    } else {
                        $td.append("<img src='" + ((layerInfo.legendIcon.indexOf("https://") == 0 || layerInfo.legendIcon.indexOf("http://") == 0) ? "" : "../") + layerInfo.legend.url + "' style='width:22px; height:22px;'/>");
                        $td.append(layerInfo.name);
                    }
                }
                if (layerInfo.editable) {
                    $td.append("<input type='button' class='BtnGrey' value='編輯' onclick=\"editLayer(this, '" + layerInfo.layerID + "')\" />");
                }
            }
        }
    }

    function hideAllLayer() {
        $("#legendTable input[type='checkbox']:checked").click();
    }
</script> -->
<!-- feature list -->
<!-- <script type="text/javascript">
    var featureListStartIndex = 0;
    var pageSize = 10;
    var listFeatureInfo = [];
    var filterKeyword = null;
    function appendFeatureList() {
        if (filterKeyword) {
            var filter = '<wfs:GetFeature service="WFS" version="2.0.0" xmlns:wfs="http://www.opengis.net/wfs/2.0" xmlns:fes="http://www.opengis.net/fes/2.0" xmlns:sf="http://www.openplans.org/spearfish" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:chiayiwater="http://www.cyhg.gov.tw/wrb">'
                + '<wfs:Query typeNames="' + editingLayerInfo.serviceInfo.params.layer + '">'
                + '<fes:Filter xmlns:fes="http://www.opengis.net/fes/2.0" xmlns:gml="http://www.opengis.net/gml/3.2">';
            if (filterKeyword.length > 1) {
                filter += "<fes:And>";
            }
            for (var i = 0; i < filterKeyword.length; i++) {
                var fields = editingLayerInfo.serviceInfo.fields;
                if (fields.length > 1) {
                    filter += "<fes:Or>";
                }
                for (var j = 0; j < fields.length; j++) {
                    filter += "<fes:PropertyIsLike wildCard='*' singleChar='.' escapeChar='!'>"
                        + "<fes:ValueReference>" + $("<div>").text(fields[j]).html() + "</fes:ValueReference>"
                        + "<fes:Literal>*" + $("<div>").text(filterKeyword[i].replace(/([.!*])/g, "!$1")).html() + "*</fes:Literal>"
                        + "</fes:PropertyIsLike>";
                }
                if (fields.length > 1) {
                    filter += "</fes:Or>";
                }
            }
            if (filterKeyword.length > 1) {
                filter += "</fes:And>";
            }
            filter += '</fes:Filter>'
                + '</wfs:Query></wfs:GetFeature>';
        }
        var queryOption = {
            filter: filter
        };
        mapPlugin.layersMg.getPagingFeatures(editingLayerInfo, queryOption, pageSize, featureListStartIndex, appendFeaturesInList);
    }

    function appendFeaturesInList(retObj) {
        retObj.features.forEach(appendFeature);
        if (!retObj.hasMore || retObj.features.length < pageSize) {
            $(".BtnPage").hide();
        }
    }

    function appendFeature(feature) {
        listFeatureInfo[featureListStartIndex] = {
            featureID: feature.getId(),
            geom: feature.getGeometry().getType() == "Point" ? feature.getGeometry() : feature.getGeometry().getExtent(),
            feature: feature
        };
        var idx = featureListStartIndex;
        $("#featureList").append(
            "<tr>" +
            "<td>" + (idx + 1) + "</td>" +
            "<td class='_Label'>" + mapPlugin.layersMg.genLabel(editingLayerInfo, feature) + "</td>" +
            "<td>" +
            "<input type='hidden' class='_FeatureID' value='" + feature.getId() + "'>" +
            '<input type="button" class="BtnListDel"  style="float: right" onClick="deleteFeature(\'' + feature.getId() + '\', this)">' +
            '<input type="button" class="BtnListEdit"  style="float: right" onClick="editFeatureByIdx(' + idx + ')">' +
            "</td>" +
            "</tr>"
        );
        featureListStartIndex++;
    }

    function queryFeature() {
        $("#featureList").find("tr").filter(function (idx) { return idx > 0; }).remove();
        $("#spanTitle").text(editingLayerInfo.serviceInfo.label.title);
        $(".BtnPage").show();
        featureListStartIndex = 0;
        listFeatureInfo = [];
        var keyword = $("#txtKeyword").val();
        if (keyword.replace(" ", "").length == 0) {
            filterKeyword = null;
        } else {
            filterKeyword = $.trim(keyword).split(/\s+/);
        }
        appendFeatureList();
    }

    function downloadKML() {
        location = mapPlugin.layersMg.getKMLUrl(editingLayerInfo, true);
    }
</script> -->
<!-- feature edit -->
<!-- <script type="text/javascript">
    function editFeatureByIdx(idx) {
        var featureInfo = listFeatureInfo[idx];
        mapPlugin.editorTool.selectFeature(featureInfo.featureID, featureInfo.geom);
    }

    function addingFeature() {
        mapPlugin.editorTool.addingFeature();
    }

    function editFeature(feature) {
        editingFeature = feature;
        editingFeature.on('change', reloadEditingFeatureGeometry);
        if (editingLayerInfo.geometryType.toUpperCase() == "POINT") {
            $("#PointGeometryEditor").show();
            var coord = mapPlugin.transCoordinateFromMapPrj(feature.getGeometry().getFirstCoordinate(), parent.displayPrj);
            $("#txtFeatureX").val(coord[0].toFixed(digit));
            $("#txtFeatureY").val(coord[1].toFixed(digit));
        } else {
            $("#PointGeometryEditor").hide();
        }
        $("#featureProperties").children().remove();
        var keys = feature.getKeys();
        keys.forEach(function (key) {
            var value = feature.get(key);
            if (["object", "function"].indexOf(typeof (value)) < 0 || (value == null && feature.getGeometryName() != key)) {
                $("#featureProperties").append(
                    "<tr>" +
                    "<th>" + mapPlugin.layersMg.getFieldLabel(editingLayerInfo, key) + "</th>" +
                    "<td>" +
                    '<input type="text" style="width:100%" id="f_' + key + '">' +
                    "</td>" +
                    "</tr>"
                );
                $("#f_" + key).val(value);
            }
        });

        mapPlugin.editorTool.isAutoSave = false;
        $('#features').hide();
        $('#featureEditor').show();
        mapPlugin.locateTool.locateToFeature(feature);
    }

    function saveFeature() {
        if (!editingFeature) {
            alert("請先設定圖資空間位置");
            return;
        }
        // check data
        var bCheckError = false;
        var strErrorMsg = "";
        editingFeature.getKeys().forEach(function (key) {
            var value = editingFeature.get(key);
            if (["object", "function"].indexOf(typeof (value)) < 0 || (value == null && editingFeature.getGeometryName() != key)) {
                if ($("#f_" + key).hasClass("_Must") && $.trim($("#f_" + key).val()) == "") {
                    strErrorMsg += "";
                    bCheckError = true;
                    return;
                }
            }
        });
        // set data into feature instance
        editingFeature.getKeys().forEach(function (key) {
            var value = editingFeature.get(key);
            if (["object", "function"].indexOf(typeof (value)) < 0 || (value == null && editingFeature.getGeometryName() != key)) {
                editingFeature.set(key, $("#f_" + key).val());
            }
        });
        mapPlugin.editorTool.saveFeatures({
            success: function () {
                // 儲存成功後
                var $labelContainer = $("._FeatureID[value='" + editingFeature.getId() + "']").parent().parent().find("._Label");
                if ($labelContainer.length == 0) {
                    if ($(".BtnPage").css("display") == "none") {
                        appendFeature(editingFeature);
                    }
                } else {
                    $labelContainer.text("");
                    $labelContainer.append(mapPlugin.layersMg.genLabel(editingLayerInfo, editingFeature));
                }
                stopEditingFeature();
            }
        });
    }

    function stopEditingFeature() {
        $("#featureEditor").hide();
        $('#features').show();
        mapPlugin.editorTool.clearSelected();
        mapPlugin.editorTool.isAutoSave = true;
        clearEditingFeature();
    }

    function deleteFeature(featureID, obj) {
        if (confirm("您確定刪除嗎?")) {
            mapPlugin.editorTool.deleteFeature(featureID);
            mapPlugin.editorTool.saveFeatures(
                {
                    success: function () {
                        $(obj).parent().parent().remove();
                    }
                }
            );
        }

    }

    function clearEditingFeature() {
        if (editingFeature) {
            editingFeature.un('change', reloadEditingFeatureGeometry);
        }
        editingFeature = null;
        featureEditor = null;
        $("#txtFeatureX").val("");
        $("#txtFeatureY").val("");
        $("#txtFeatureName").val("");
    }
</script> -->
<!-- external layer -->
<!-- <script type="text/javascript">
    function showLayerAddingPanel() {
        $("#legend").hide();
        $("#addExternalLayer").show();
        $("input.BtnTab").removeClass("TabActive");
        $("input.BtnTab[value='+新增圖層']").addClass("TabActive");
        $("input[name='layerType']:checked").click();
    }
    function closeLayerAddingPanel() {
        $("#addExternalLayer").hide();
        $("#legend").show();
        mapPlugin.layersMg.deactiveDragAndDrop();
    }
    function switchToLayerInfo(target) {
        $(".LayerInfo").hide();
        $("#" + target).show();
        if (target == "kmlLayerInfo") {
            if (typeof FileReader == "undefined") {
                $("#kmlLayerInfo tr:eq(1)").hide();
                $("#kmlLayerInfo tr:eq(2)").show();
            } else {
                // 支援HTML5 drag-and-drop才可以使用拖拉套用
                $("#kmlLayerInfo tr:eq(1)").show();
                $("#kmlLayerInfo tr:eq(2)").hide();
                mapPlugin.layersMg.activeDragAndDrop(function (evt) {
                    try {
                        var layerKey = new Date().getTime().toString();
                        var layerInfo = {
                            name: $("#kmlLayerName").val(),
                            type: "node",
                            legendIcon: "./App_Themes/map/images/16.png",
                            serviceInfo: {
                                type: "vector",
                                bubbleContent: "#AUTO#"
                            }
                        };
                        mapPlugin.layersMg.addLayerInfo("其他", layerKey, layerInfo);
                        var layer = mapPlugin.layersMg.addLayer(layerInfo);
                        layer.getSource().addFeatures(evt.features);
                        $("#kmlLayerName").val("");
                        $("#kmlURL").val("");
                        switchLayerTab("其他");
                        mapPlugin.locateTool.zoomToLayer(layer);
                    } catch (e) {
                        console.error(e);
                    }
                });
            }
        } else {
            mapPlugin.layersMg.deactiveDragAndDrop();
        }
    }
    function addLayer() {
        var layerType = $("input[name='layerType']:checked").val();
        if (layerType == "kml") {
            $("#ifKmlUpload").contents().find("#btnUpload").click();
            //var layer = addKMLLayerInfo($("#kmlLayerName").val(), $("#kmlURL").val());
            //$("#kmlLayerName").val("");
            //$("#kmlURL").val("");
            //switchLayerTab("其他");
            //mapPlugin.locateTool.zoomToLayer(layer);
        } else if (layerType == "gml") {
            var layerInfo = {
                name: $("#gmlLayerName").val(),
                type: "node",
                legendIcon: "./App_Themes/map/images/16.png",
                serviceInfo: {
                    type: "gml",
                    url: $("#gmlURL").val()
                }
            };
            mapPlugin.layersMg.addLayerInfo("其他", new Date().getTime().toString(), layerInfo);
            var layer = mapPlugin.layersMg.addLayer(layerInfo);
            $("#gmlLayerName").val("");
            $("#gmlURL").val("");
            switchLayerTab("其他");
            mapPlugin.locateTool.zoomToLayer(layer);
        } else if (layerType == "wms") {
            mapPlugin.layersMg.addWMSSource("其他", $("#wmsURL").val(),
                function () {
                    switchLayerTab("其他");
                }
            );
        } else if (layerType == "wfs") {
            mapPlugin.layersMg.addWFSSource("其他", $("#wfsURL").val(),
                function () {
                    switchLayerTab("其他");
                }
            );
        } else if (layerType == "shp") {
            $("#ifShpUpload").contents().find("#hfCRS").val($("#ddlShpCoordSys").val());
            $("#ifShpUpload").contents().find("#btnUpload").click();
        }
        //closeLayerAddingPanel();
    }

    function addKMLLayerInfo(layerName, kmlURL) {
        if (!layerName || layerName.replace(/ /g, "") == "") {
            layerName = $("#kmlLayerName").val();
        }
        var layerInfo = {
            name: layerName,
            type: "node",
            legendIcon: "./App_Themes/map/images/16.png",
            serviceInfo: {
                type: "kml",
                url: kmlURL,
                bubbleContent: "#AUTO#"
            }
        };
        mapPlugin.layersMg.addLayerInfo("其他", new Date().getTime().toString(), layerInfo);
        var layer = mapPlugin.layersMg.addLayer(layerInfo);
        return layer;
    }

    function addKML(kmlURL) {
        var layer = addKMLLayerInfo($("#kmlLayerName").val(), kmlURL);
        $("#kmlLayerName").val("");
        switchLayerTab("其他");
        mapPlugin.locateTool.zoomToLayer(layer);
    }

    function addShp(kmlURL) {
        var layer = addKMLLayerInfo($("#shpLayerName").val(), kmlURL);
        $("#shpLayerName").val("");
        switchLayerTab("其他");
        mapPlugin.locateTool.zoomToLayer(layer);
    }


</script> -->
<!-- page event -->
<!-- <script type="text/javascript">
    function page_active() {

    }
    function page_leave() {
        //backToLegend();
        //closeLayerAddingPanel();
    }
    function action_clear() {
        hideAllLayer();
    }
</script> -->

</html>