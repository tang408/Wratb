<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="../script/map/jquery.js" type="text/javascript"></script>
    <script src="../script/map/jquery-ui.min.js" type="text/javascript"></script>
    <link href="../App_Themes/Map/css/reset.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/map.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/main.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/layout.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/jquery-ui.css" rel="stylesheet" type="text/css" />
    <link href="../App_Themes/Map/css/nanoscroller.css" rel="stylesheet" type="text/css" />
    <script src="../script/map/AssessTools.js" type="text/javascript"></script>
    <script type="text/javascript">
        var resizeInterval = null;
        $(function () {
            //$("#underlay").accordion();
            $("#underlay > div").draggable({
                appendTo: "body",
                helper: "clone"
            });

            $("#shownLayers").sortable({
                change: function (event, ui) {
                    console.log("change : " + $("#shownLayers").children().index(ui.item));
                },
                start: function (event, ui) {
                    console.log("start : " + $("#shownLayers").children().index(ui.item));
                },
                stop: function (event, ui) {
                    var currentPos = $("#shownLayers").children().index(ui.item);
                    parent.changeBaseLayerPostion(layerMapping[getMapID(ui.item[0].className)], currentPos);
                },
                out: function (event, ui) {
                    console.log("out : " + $("#shownLayers").children().index(ui.item));
                },
                receive: function (event, ui) {
                    console.log("receive : " + $("#shownLayers").children().index(ui.item));
                }
            });
            $("#shownLayers").disableSelection();
            $(".map_add").droppable({
                activeClass: "ui-state-default",
                hoverClass: "ui-state-hover",
                accept: ":not(.ui-sortable-helper)",
                drop: function (event, ui) {
                    var $src = $(ui.draggable[0].innerHTML);
                    $src.removeClass("maptrans");
                    $src.removeClass("ui-sortable-handle");
                    var $ori = $("#underlay ." + $src[0].className);
                    if (switchBaseLayer(layerMapping[$src[0].className])) {
                        $ori.parent().remove();
                        $src.append('<input type="button" class="BtnDelete" onclick="removeBaseLayer(\'' + $src[0].className + '\')" />'
                                  + '<input type="button" class="BtnTrans" onclick="showBaseLayerOpacitySilder(\'' + $src[0].className + '\')"/>')
                            .insertBefore("#shownLayers > div:first");
                    }
                }
            });
            resizeInterval = setInterval(resizeLayout, 200);
            $(document.body).on('mousedown', function () {
                $('#layerOpacityPanel').hide();
            });
            $('#layerOpacityPanel').on('mousedown', function (e) {
                if (event.stopPropagation) {
                    event.stopPropagation();
                } else {
                    event.cancelBubble = true;
                }
            });
        });
        function resizeLayout() {
            parent.resizeBox($(".nano").offset().top + $(".nano-content > div").height() + 20);
            if ($(".nano").height() != ($("html").height() - $(".nano").offset().top)) {
                $(".nano").height($("html").height() - $(".nano").offset().top);
            }
            clearInterval(resizeInterval);
        }
        $(window).on("resize", function () {
            clearInterval(resizeInterval);
            resizeInterval = setInterval(resizeLayout, 200);
        });

        var layerMapping = {
            "map01": "電子地圖",
            "map02": "電子地圖(含等高線)",
            "map03": "正射(航照)地圖",
            "map04": "福衛二號混合圖",
            "map05": "電子地圖(僅道路)",
            "map06": "地形暈渲混合圖"
        };
        function switchBaseLayer(target) {
            return parent.switchBaseLayer(target);
        }
        // 顯示透明度拖拉bar
        function showBaseLayerOpacitySilder(target) {
            var opacity = parent.getBaseLayerOpacity(layerMapping[target]);
            $("#opacitySlider").slider({
                value: opacity * 100,
                orientation: "horizontal",
                range: "min",
                animate: true,
                stop: function () {
                    parent.setBaseLayerOpacity(layerMapping[target],$("#opacitySlider").slider("value")/100);
                }
            });
            $("#layerOpacityPanel").css("left", window.event.clientX - 150).css("top", window.event.clientY).show();
        }

        function removeBaseLayer(target) {
            if ($("#shownLayers > div").length == 1) return;
            if (switchBaseLayer(layerMapping[target])) {
                var $target = $("." + target);
                $("<div> <div class='" + $target[0].className + " maptrans'>" + $target.text() + "</div></div>").appendTo("#underlay");
                $("#shownLayers ." + target).remove();
                $("#underlay > div").draggable({
                    appendTo: "body",
                    helper: "clone"
                });
                $("#shownLayers").sortable();
                $("#shownLayers").disableSelection();
            }
        }

        function getMapID(className) {
            var names = className.split(" ");
            for (var idx in names) {
                if (names[idx].indexOf("map") == 0) {
                    return names[idx];
                }
            }
        }
    </script>
    <!-- page event -->
    <script type="text/javascript">
        function page_active() {

        }
        function page_leave() {
        }
    </script>
</head>
<body>
    <!--關閉+說明-->
    <div class="BtnFunc">
        <ul>
            <li class="close"><a href="javascript:void(0);parent.toolSwitch()">關閉</a></li>
        </ul>
    </div>
    <!--可捲動範圍-->
    <div class="nano">
        <div class="nano-content">
            <div>
                <!--已套疊的區塊-->
                <div class="BaseMapTop">
                    <div class="map_add">
                        請將欲開啟之底圖(下方灰色區塊)拖曳至此</div>
                    <div id="shownLayers">
                        <div>
                        </div>
                            <div class="map02">
                                通用版電子地圖
                                <input type="button" class="BtnDelete" onclick='removeBaseLayer("map02")' />
                                <input type="button" class="BtnTrans" onclick='showBaseLayerOpacitySilder("map02")' />
                            </div>
                    </div>
                    <p>
                        拖曳底圖可改變套疊順序</p>
                </div>
                <div id="underlay" class="BaseMapDown">
                    <h1>
                        底圖</h1>
                    <div>
                        <div class="map01 maptrans">
                            內政部TGOS電子地圖
                        </div>
                    </div>
                    <div>
                        <div class="map05 maptrans">
                            通用版電子地圖(僅道路)</div>
                    </div>
                    <div>
                        <div class="map03 maptrans">
                            正射影像（通用版）</div>
                    </div>
                    <div>
                        <div class="map04 maptrans">
                            福衛二號混合圖</div>
                    </div>
                    <div>
                        <div class="map06 maptrans">
                            地形暈渲混合圖</div>
                    </div>
                </div>
                <!--底圖區塊結尾-->
            </div>
        </div>
    </div>
    <!--可捲動範圍結尾-->
    <div id="layerOpacityPanel" class="transp" style="position:absolute; z-index:99; display:none;">
        <div class="BtnFunc">
            <ul>
                <li id="opacitySlider" style="float:left; width:110px;margin:5px;"></li>
                <li class="close"><a href="javascript:void(0);" onclick="$('#layerOpacityPanel').hide()">關閉</a></li>
            </ul>
        </div>
        <!--關閉+說明-->
    </div>
</body>
</html>
